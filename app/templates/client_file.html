<!doctype html>
<html lang="fr">

<head>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.18/index.global.min.js'></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/client_file.css') }}">
    <meta charset="UTF-8">
    <title>Fiche résident</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- central-panel + client-list helpers moved to client_file.css -->
</head>

<body>
    <!-- page-specific styles moved to client_file.css -->
    <div class="sidebar">
        <button onclick="window.location.href='{{ url_for('main.journee') }}'"
            class="menu-btn{% if request.path == url_for('main.journee') %} active{% endif %}">Page principale</button>
        <button onclick="window.location.href='{{ url_for('main.client_file') }}'"
            class="menu-btn{% if request.path == url_for('main.client_file') %} active{% endif %}">Fiche
            résident</button>
        <button onclick="window.location.href='{{ url_for('main.form') }}'"
            class="menu-btn{% if request.path == 'main.form' or request.path == '/' %} active{% endif %}">Prise de
            rendez-vous</button>
        <button onclick="window.location.href='{{ url_for('main.emploi_collectif') }}'"
            class="menu-btn{% if request.path == url_for('main.emploi_collectif') %} active{% endif %}">Emploi du temps
            collectif</button>
        <button onclick="window.location.href='{{ url_for('main.admin') }}'"
            class="menu-btn{% if request.path == url_for('main.admin') %} active{% endif %}">Administration</button>
        <div class="separator-vertical"></div>
        <button id="imprimerBtn" class="menu-btn" style="margin-top: 40px;">Imprimer</button>
    </div>

    <div class="central-panel">
        <!-- Popup Impression -->
        <div id="impressionPopup"
            style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(35,41,70,0.18); z-index:9999; justify-content:center; align-items:center;">
            <div id="impressionPopupContent"
                style="background:#fff; border-radius:18px; box-shadow:0 8px 32px rgba(35,41,70,0.18); padding:32px; max-width:90vw; max-height:80vh; overflow:auto; position:relative;">
                <button onclick="closeImpressionPopup()"
                    style="position:absolute; top:18px; right:18px;">Fermer</button>
                <button onclick="printImpressionContent()"
                    style="position:absolute; top:18px; left:18px; background:#4F8CFF; color:#fff; border:none; border-radius:8px; padding:10px 22px; font-size:1em; font-weight:600; cursor:pointer;">Imprimer</button>
                <div id="impressionContentInner" style="margin-top:56px;"></div>
            </div>
        </div>

        <!-- Popup DF (PDF iframe) for row/pdf printing -->
        <div id="impressionPopupDF"
            style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(35,41,70,0.18); z-index:100000; justify-content:center; align-items:center;">
            <div
                style="background:#fff; border-radius:12px; box-shadow:0 8px 32px rgba(35,41,70,0.18); padding:20px; max-width:90vw; max-height:90vh; width:100%; position:relative;">
                <button onclick="closeImpressionPopupDF()"
                    style="position:absolute; top:12px; right:12px;">Fermer</button>
                <button onclick="printIframe()"
                    style="position:absolute; top:12px; left:12px; background:#4F8CFF; color:#fff; border:none; border-radius:8px; padding:8px 14px; cursor:pointer;">Imprimer</button>
                <iframe id="pdfIframe" style="width:100%; height:78vh; border:none; margin-top:48px;"></iframe>
            </div>
        </div>



        <div style="padding-top:100px; margin-left:0;">
            <div
                style="width:calc(100vw - 200px); margin-left:0; margin-top:0; margin-bottom:32px; height:80px; background: linear-gradient(135deg, #5A8DEE 0%, #3B6FCC 100%); box-shadow:0 4px 24px rgba(35,41,70,0.10); border-radius:0 0 32px 32px; display:flex; align-items:center; padding-left:48px; position:fixed; top:0; left:200px; z-index:101;">
                <img src="https://img.icons8.com/ios-filled/48/ffffff/user-male-circle.png" alt="Logo"
                    style="height:48px; width:48px; margin-right:24px; filter:drop-shadow(0 2px 8px #23294655);">
                <span
                    style="font-size:2.2em; font-weight:700; color:#fff; letter-spacing:2px; text-shadow:0 2px 8px #23294655;">Fiche
                    résidents</span>
            </div>

            <!-- Remplacement : conteneur fixe pour aligner les 3 boutons -->
            <div class="top-actions"
                style="position:fixed; top:130px; left:200px; right:40px; z-index:1000; display:flex; align-items:center; justify-content:center; ">
                <!-- bouton gauche (ancré à gauche du conteneur) -->
                <button id="openPopupBtn" class="openPopupBtn" style="position:absolute; left:0;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    <span>Ajout d'un nouveau résident</span>
                </button>

                <!-- bouton centré -->
                <button id="show-graph"
                    style="pointer-events:auto; background:#3B6FCC; color:#f7f7fa; border:none; border-radius:6px; padding:10px 24px; font-size:1em; font-weight:600; cursor:pointer;">Historique
                    des selles</button>

                <!-- bouton droit (ancré à droite du conteneur) -->
                <button id="openDepartPopupBtn" class="openPopupBtn"
                    style="position:fixed; top:130px; right:40px; z-index:1000; display:flex; align-items:center; gap:8px; background:#C82333;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    <span>Départ d'un résident</span>
                </button>
            </div>

            <!-- Popup Départ résident -->
            <div id="departPopupForm" class="popup-overlay"
                style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:999; justify-content:center; align-items:center;">
                <div class="popup-content noselect"
                    style="background:#fff; padding:32px 24px; border-radius:12px; box-shadow:0px 8px 32px rgba(0,0,0,0.18); min-width:500px; max-width:1728px;">
                    <h3 class="noselect">Départ d'un résident</h3>
                    <form id="departPopupFormInner" autocomplete="off"
                        style="display:flex; flex-direction:column; gap:12px;">
                        <!-- Nom du résident à supprimer -->
                        <label class="noselect" style="font-family:Arial, sans-serif; font-size:14px; color:#232946;">
                            Nom du résident :
                            <div style="position:relative;">
                                <input type="text" name="nomPatientEDT_affichage" id="departNomPatientInput"
                                    autocomplete="off" placeholder="Commencez à taper..." required
                                    style="padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none;"
                                    onfocus="showDepartPatientList()" oninput="filterDepartPatientList()">
                                <input type="hidden" name="nomPatientEDT" id="departNomPatientHidden">
                                <div id="departPatientList"
                                    style="display:none; position:absolute; left:0; right:0; background:#fff; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:10;">
                                    {% for nom in residents %}
                                    <div class="patient-item" data-pk="{{ pks[loop.index0] }}"
                                        style="padding:8px; cursor:pointer;" onclick="selectDepartPatient(this)">
                                        {{ nom }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </label>
                        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; justify-content:center;">
                            <button type="submit" class="btn-valider" style="background:#C82333;">Valider</button>
                            <button type="button" id="closeDepartPopupBtn"
                                style="background:#232946; font-weight:bold; color:#fff; border:none; border-radius:6px; padding:8px 18px; font-size:16px; cursor:pointer;">Annuler</button>
                        </div>
                    </form>
                </div>
            </div>



            <div id="popup" style="display:none; position:fixed; top:50%; left:50%; 
        transform:translate(-50%, -50%);
        background:white; border:2px solid black; z-index:1000; 
        overflow:auto; padding:10px;">
                <span id="popup-close"
                    style="position:absolute; top:5px; right:5px; cursor:pointer; font-weight:bold; font-size:18px; z-index:2000; color:black;">
                    X
                </span>
                <div id="graph-container" style="width:700px; height:500px;"></div>
            </div>

            <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


            <div id="popupForm" class="popup-overlay"
                style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:999; justify-content:center; align-items:center;">
                <div class="popup-content noselect"
                    style="background:#fff; padding:32px 24px; border-radius:12px; box-shadow:0px 8px 32px rgba(0,0,0,0.18); min-width:500px; max-width:1728px;">
                    <h3 class="noselect">Ajouter un nouveau résident</h3>
                    <form id="popupFormInner" autocomplete="off" style="display:flex; flex-direction:column; gap:12px;">

                        <!-- Nom -->
                        <label class="noselect"
                            style="display:flex; flex-direction:column; gap:5px; font-family:Arial, sans-serif; font-size:14px; color:#232946;">
                            Nom:
                            <input type="text" name="nom" required
                                style="padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; transition: border 0.3s, box-shadow 0.3s;"
                                onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                        </label>

                        <!-- Prénom -->
                        <label class="noselect"
                            style="display:flex; flex-direction:column; gap:5px; font-family:Arial, sans-serif; font-size:14px; color:#232946;">
                            Prénom:
                            <input type="text" name="prenom" required
                                style="padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; transition: border 0.3s, box-shadow 0.3s;"
                                onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                        </label>

                        <!-- Date de naissance -->
                        <label class="noselect"
                            style="display:flex; flex-direction:row; gap:8px; justify-content:center; align-items:center; font-family:Arial, sans-serif; font-size:14px; color:#232946;">
                            Date de naissance:
                            <input type="date" name="date_naissance" required
                                style="padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; transition: border 0.3s, box-shadow 0.3s;"
                                onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                        </label>

                        <!-- Sexe, Étage, Chambre -->
                        <div class="noselect" style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center;">

                            <!-- Sexe -->
                            <label
                                style="display:flex; flex-direction:column; gap:5px; font-family:Arial, sans-serif; font-size:14px; color:#232946; justify-content:center;">
                                Sexe:
                                <select name="gender" required
                                    style="width:200px; padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; cursor:pointer; transition: border 0.3s, box-shadow 0.3s;"
                                    onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                    onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                                    <option value="homme">Homme</option>
                                    <option value="femme">Femme</option>
                                </select>
                            </label>

                            <!-- Étage -->
                            <label
                                style="display:flex; flex-direction:column; gap:5px; font-family:Arial, sans-serif; font-size:14px; color:#232946; justify-content:center;">
                                Étage:
                                <select name="etage" required
                                    style="width:100px; padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; cursor:pointer; transition: border 0.3s, box-shadow 0.3s;"
                                    onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                    onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </label>

                            <!-- Chambre -->
                            <label
                                style="display:flex; flex-direction:column; gap:5px; font-family:Arial, sans-serif; font-size:14px; color:#232946;">
                                Chambre:
                                <input type="text" name="chambre" required
                                    style="width:200px; padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; transition: border 0.3s, box-shadow 0.3s;"
                                    onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                    onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                            </label>

                        </div>

                        <!-- Mode de déplacement -->
                        <label class="noselect"
                            style="display:flex; flex-direction:column; gap:5px; font-family:Arial, sans-serif; font-size:14px; color:#232946;">
                            Mode de déplacement:
                            <select name="deplacement" required
                                style="padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; cursor:pointer; transition: border 0.3s, box-shadow 0.3s;"
                                onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                                <option value="Seul">Seul</option>
                                <option value="Canne">Canne</option>
                                <option value="Deambulateur">Déambulateur</option>
                                <option value="Fauteil">Fauteil roulant</option>
                                <option value="Lit">Alité</option>
                            </select>
                        </label>

                        <!-- O2 et Diabète -->
                        <div style="display:flex; gap:12px; flex-wrap:wrap;">
                            <label
                                style="display:flex; align-items:center; gap:4px; font-family:Arial, sans-serif; font-size:14px; color:#232946; cursor:pointer;">
                                O2:
                                <input type="checkbox" name="O2" value="1"
                                    style="width:12px; height:12px; border:1px solid #ccc; background:#f0f0f5; cursor:pointer; appearance:none; position:relative;"
                                    onclick="this.style.background=this.checked?'#003366':'#f0f0f5';">
                            </label>

                            <label
                                style="display:flex; align-items:center; gap:4px; font-family:Arial, sans-serif; font-size:14px; color:#232946; cursor:pointer;">
                                Diabète:
                                <input type="checkbox" name="diabete" value="1"
                                    style="width:12px; height:12px; border:1px solid #ccc; background:#f0f0f5; cursor:pointer; appearance:none; position:relative;"
                                    onclick="this.style.background=this.checked?'#003366':'#f0f0f5';">
                            </label>
                        </div>

                        <!-- Commentaire -->
                        <label class="noselect"
                            style="display:flex; flex-direction:column; gap:5px; font-family:Arial, sans-serif; font-size:14px; color:#232946;">
                            Commentaire:
                            <input type="text" name="commentaire" required
                                style="padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; transition: border 0.3s, box-shadow 0.3s;"
                                onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                        </label>

                        <!-- Boutons -->
                        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; justify-content:center;">
                            <button type="submit" class="btn-valider">Valider</button>
                            <button type="button" id="closePopupBtn"
                                style="background:#C82333; font-weight:bold; color:#fff; border:none; border-radius:6px; padding:8px 18px; font-size:16px; cursor:pointer;">Annuler</button>
                        </div>

                    </form>
                </div>
            </div>


            <div id="popupMessage" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
            background:#1e7e34; color:#fff; padding:32px 48px; border-radius:16px;
            font-size:20px; min-width:320px; text-align:center;
            font-weight:bold; box-shadow:0 8px 32px rgba(0,0,0,0.35);
            z-index:2000; opacity:0; transition:opacity 0.3s ease;">
            </div>




            <form method="post" action="{{ url_for('main.client_file') }}" class="">
                <label>Nom du résident :</label>

                <div style="position:relative;">
                    <input type="text" name="nomPatientEDT_affichage" id="nomPatientInput" autocomplete="off"
                        placeholder="Commencez à taper..." required onfocus="showPatientList()"
                        oninput="filterPatientList()">
                    <input type="hidden" name="nomPatientEDT" id="nomPatientHidden"> <!-- ici la pk envoyée -->

                    <div id="patientList"
                        style="display:none; position:absolute; left:0; right:0; background:#fff; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:10;">
                        {% for nom in residents %}
                        <div class="patient-item" data-pk="{{ pks[loop.index0] }}" style="padding:8px; cursor:pointer;"
                            onclick="selectPatient(this)">
                            {{ nom }}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <button type="submit" id="validerBtn" class="btn-valider">Valider</button>

            </form>

            <script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>




            {% if results is not none or (nodes is defined and nodes|length > 0) %}
            <div class="fiche-flex-container" style="margin-top:32px;">





                <div class="client-list fiche-carte">
                    <h3>Informations du résident</h3>
                    {% if results is not none and results.shape[0] > 0 %}
                    {% set row = results.iloc[0] %}
                    <form id="editResidentForm" method="POST" action="{{ url_for('main.edit_resident') }}">
                        <!-- Votre champ hidden contenant la PK -->
                        <input type="hidden" name="resident_id" id="residentIdHidden" value="{{ row['pk'] }}">
                        <!-- MODE LECTURE -->
                        <div class="view-mode">
                            <div
                                style="font-size: 1.5em; font-weight: 600; color: #232946; margin-bottom: 8px; text-align: center;">
                                {{ row['nom'] if 'nom' in row else '' }} {{ row['prenom'] if 'prenom' in row else '' }}
                            </div>
                            {% if 'sexe' in row %}
                            <div
                                style="font-size: 1.1em; color: #555; margin-bottom: 8px; width: 100%; text-align: center;">
                                Sexe : <b>{{ row['sexe']|capitalize }}</b>
                            </div>
                            {% endif %}
                            {% if 'etage' in row %}
                            <div
                                style="font-size: 1.1em; color: #555; margin-bottom: 8px; width: 100%; text-align: center;">
                                Étage : <b>{{ row['etage'] }}</b>
                            </div>
                            {% endif %}
                            {% if 'chambre' in row %}
                            <div
                                style="font-size: 1.1em; color: #555; margin-bottom: 8px; width: 100%; text-align: center;">
                                Chambre : <b>{{ row['chambre'] }}</b>
                            </div>
                            {% endif %}
                            {% if 'oxygen' in row %}
                            <div style="margin-bottom: 8px; width: 100%; text-align: center;">
                                O₂ : <b>{{ 'Oui' if row['oxygen']=='1' else 'Non' }}</b>
                            </div>
                            {% endif %}
                            {% if 'diabete' in row %}
                            <div style="margin-bottom: 8px; width: 100%; text-align: center;">
                                Diabète : <b>{{ 'Oui' if row['diabete']=='1' else 'Non' }}</b>
                            </div>
                            {% endif %}
                            {% if 'commentaire' in row %}
                            <div style="margin-bottom: 8px; width: 100%; text-align: center;">
                                Note : <b>{{ row['commentaire'] }}</b>
                            </div>
                            {% endif %}
                            {% if 'naissance' in row %}
                            <div style="margin-bottom: 8px; width: 100%; text-align: center;">
                                Date de naissance :
                                <b id="naissance">{{ row['naissance'] }}</b>
                            </div>
                            {% endif %}
                            {% if 'deplacement' in row %}
                            <div style="margin-bottom: 8px; width: 100%; text-align: center;">
                                Déplacement : <b>{{ row['deplacement'] }}</b>
                            </div>
                            {% endif %}

                        </div>

                        <!-- MODE ÉDITION -->
                        <div class="edit-mode" style="display:none;">
                            <div
                                style="font-size: 1.5em; font-weight: 600; color: #232946; margin-bottom: 8px; text-align: center;">
                                {{ row['nom'] if 'nom' in row else '' }} {{ row['prenom'] if 'prenom' in row else '' }}
                            </div>
                            Sexe: <select name="gender" required
                                style="width:100px; padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; cursor:pointer; transition: border 0.3s, box-shadow 0.3s;"
                                onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                                <option value="homme">Homme</option>
                                <option value="femme">Femme</option>
                            </select>
                            <br>
                            Étage:
                            <select name="etage" required
                                style="width:100px; padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; cursor:pointer; transition: border 0.3s, box-shadow 0.3s;"
                                onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                                <option value="0" {% if row['etage']==0 or row['etage']=='0' %}selected{% endif %}>0
                                </option>
                                <option value="1" {% if row['etage']==1 or row['etage']=='1' %}selected{% endif %}>1
                                </option>
                                <option value="2" {% if row['etage']==2 or row['etage']=='2' %}selected{% endif %}>2
                                </option>
                                <option value="3" {% if row['etage']==3 or row['etage']=='3' %}selected{% endif %}>3
                                </option>
                            </select>
                            <br>
                            Chambre:
                            <input type="text" name="chambre" required
                                value="{{ row['chambre'] if 'chambre' in row else '' }}"
                                style="width:200px; padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; transition: border 0.3s, box-shadow 0.3s;"
                                onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                            <br>
                            O2:
                            <input type="checkbox" name="O2" value="1" {% if row['oxygen']=='1' %}checked{% endif %}
                                style="width:12px; height:12px; border:1px solid #ccc; background:#f0f0f5; cursor:pointer;  position:relative;"
                                onclick="this.style.background=this.checked?'#003366':'#f0f0f5';">

                            Diabète:
                            <input type="checkbox" name="diabete" value="1" {% if row['diabete']=='1' %}checked{% endif
                                %}
                                style="width:12px; height:12px; border:1px solid #ccc; background:#f0f0f5; cursor:pointer; position:relative;"
                                onclick="this.style.background=this.checked?'#003366':'#f0f0f5';">
                            <br>
                            Mode de déplacement:
                            <select name="deplacement" required
                                style="width:100px; padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; cursor:pointer; transition: border 0.3s, box-shadow 0.3s;"
                                onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">
                                <option value="Seul" {% if row['deplacement']=='Seul' %}selected{% endif %}>Seul
                                </option>
                                <option value="Canne" {% if row['deplacement']=='Canne' %}selected{% endif %}>Canne
                                </option>
                                <option value="Deambulateur" {% if row['deplacement']=='Deambulateur' %}selected{% endif
                                    %}>Déambulateur</option>
                                <option value="Fauteil" {% if row['deplacement']=='Fauteil' %}selected{% endif %}>
                                    Fauteuil roulant</option>
                                <option value="Lit" {% if row['deplacement']=='Lit' %}selected{% endif %}>Alité</option>
                            </select>
                            <br>
                            Note:
                            <input type="text" name="commentaire" required
                                value="{{ row['commentaire'] if 'commentaire' in row else '' }}"
                                style="padding:8px 16px; border-radius:10px; border:1px solid #ccc; background:#f0f0f5; font-size:14px; font-family:inherit; color:#232946; outline:none; transition: border 0.3s, box-shadow 0.3s;"
                                onfocus="this.style.border='1px solid #003366'; this.style.boxShadow='0 0 5px rgba(0, 51, 102, 0.5)';"
                                onblur="this.style.border='1px solid #ccc'; this.style.boxShadow='none';">


                        </div>

                        <!-- BOUTONS -->
                        <button type="button" class="view-mode" onclick="enableEditMode()">
                            Modifier
                        </button>

                        <button type="submit" class="edit-mode" style="display:none;">
                            Valider
                        </button>

                        <button type="button" class="edit-mode" style="display:none;" onclick="cancelEditMode()">
                            Annuler
                        </button>
                    </form>
                    <script>
                        function enableEditMode() {
                            document.querySelectorAll('.view-mode').forEach(e => e.style.display = 'none');
                            document.querySelectorAll('.edit-mode').forEach(e => e.style.display = 'inline');
                        }

                        function cancelEditMode() {
                            document.querySelectorAll('.edit-mode').forEach(e => e.style.display = 'none');
                            document.querySelectorAll('.view-mode').forEach(e => e.style.display = 'inline');

                            // Optionnel : réinitialiser les champs à leur valeur initiale
                            document.querySelectorAll('form')[0].reset();
                        }
                    </script>



                    {% else %}
                    <p>Aucune information trouvée pour ce résident.</p>
                    {% endif %}
                </div>
                <div id="fiche-planning_id" class="fiche-planning">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; gap: 18px; margin-bottom: 8px; margin-top: 20px;">
                        <h3 style="margin-bottom:0;">Planning du résident</h3>
                        <label
                            style="display:flex; align-items:center; gap:8px; font-size:1em; user-select:none; cursor:pointer;">
                            <input type="checkbox" id="toggleHistoriqueBtn"
                                style="width:18px; height:18px; accent-color:#5A8DEE; cursor:pointer;"> Historique
                        </label>
                    </div>
                    {% if nodes is defined and nodes|length > 0 %}
                    <table class="collectif-table" id="planningTable">
                        <thead>
                            <tr>
                                {% for col in nodes[0].keys() %}
                                {% if col == "Date" %}
                                {# Ne rien afficher #}
                                
                                {% elif col == "Date_Fr" %}
                                <th>Date</th>
                                {% else %}
                                <th>{{ col }}</th>
                                {% endif %}
                                {% endfor %}
                                <th>F.R.</th>
                                <th>F.I.</th> <!-- Nouvelle colonne pour le second bouton -->
                            </tr>
                        </thead>
                        <tbody>
                            {% for node in nodes %}
                            <tr>
                                {% for col in node.keys() %}
                                {% if col == "Date" %}
                                {# Ne rien afficher #}
                                {% elif col == "Fichier" %}
                                <td style="text-align:center;">
                                    {% if node[col] %}
                                        <form method="POST"
                                            action="{{ url_for('main.download_file') }}"
                                            style="display:inline; margin:0; padding:0; border:0;">
                                            <input type="hidden" name="file_path" value="{{ node[col] }}">
                                            <button type="submit"
                                                    style="display:inline-block;
                                                            padding:6px 14px;
                                                            border-radius:8px;
                                                            background:#232946;
                                                            color:white;
                                                            border:none;
                                                            cursor:pointer;
                                                            font-size:13px;
                                                            line-height:1;">
                                                Télécharger
                                            </button>
                                        </form>
                                            {% else %}
                                        —
                                    {% endif %}
                                </td>
                                {% else %}
                                <td>{{ node[col] }}</td>
                                {% endif %}
                                {% endfor %}
                                <td style="text-align:center;">
                                    <button class="dots-btn" data-row='{{ node | tojson | safe | escape }}'
                                        style="background:none; border:none; cursor:pointer; padding:4px;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="5" cy="12" r="2" fill="#232946" />
                                            <circle cx="12" cy="12" r="2" fill="#232946" />
                                            <circle cx="19" cy="12" r="2" fill="#232946" />
                                        </svg>
                                    </button>
                                </td>
                                <td style="text-align:center;">
                                    <button class="dots-btn-alt" data-row-alt='{{ node | tojson | safe | escape }}'
                                        style="background:none; border:none; cursor:pointer; padding:4px;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="5" cy="12" r="2" fill="#232946" />
                                            <circle cx="12" cy="12" r="2" fill="#232946" />
                                            <circle cx="19" cy="12" r="2" fill="#232946" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>


                    <!-- Pop-up modale pour la ligne -->
                    <div id="rowPopupOverlay"
                        style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:99999; justify-content:center; align-items:center;">
                        <div id="rowPopupContent"
                            style="background:#fff; padding:32px 24px; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.18); min-width:320px; max-width:90vw; position:relative;">
                            <button onclick="closeRowPopup()"
                                style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.5em; color:#232946; cursor:pointer;">&times;</button>
                            <button onclick="window.print()" title="Imprimer"
                                style="position:absolute; top:10px; left:10px; background:none; border:none; cursor:pointer; padding:0;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24"
                                    fill="none" stroke="#232946" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M6 9V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v5" />
                                    <rect x="6" y="13" width="12" height="7" rx="2" />
                                    <path d="M6 17h12" />
                                    <path d="M9 17v2" />
                                    <path d="M15 17v2" />
                                    <circle cx="17" cy="7" r="1" />
                                </svg>
                            </button>
                            <div id="rowPopupInner">Chargement...</div>

                        </div>
                    </div>



                    <!-- Pop-up modale pour la nouvelle colonne -->
                    <div id="rowPopupOverlayAlt"
                        style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:99999; justify-content:center; align-items:center;">
                        <div id="rowPopupInnerAlt"
                            style="background:#fff; padding:32px 24px; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.18); min-width:320px; max-width:90vw; position:relative;">

                            <!-- Bouton fixe -->
                            <button onclick="closeRowPopupAlt()"
                                style="position:absolute; top:16px; right:16px; background:none; border:none; font-size:2em; color:#232946; cursor:pointer; line-height:1; z-index:999999;">
                                &times;
                            </button>

                            <!-- Zone de contenu dynamique -->
                            <div id="rowPopupContentAlt" style="margin-top:18px;">
                                Chargement...
                            </div>
                        </div>
                    </div>


                    {% else %}
                    <p>Aucun résultat trouvé.</p>
                    {% endif %}



                </div>
            </div>
            {% endif %}

            <div id="calendar" style="display: block;"></div>


            <!-- Client-side JS: minimal inline config (server-rendered), rest is in external file -->
            <script>
                window.clientFileConfig = window.clientFileConfig || {};
                window.clientFileConfig.nodes = {{ nodes | tojson | default ('[]') | safe }};
                window.clientFileConfig.naissance = "{{ row['naissance'] if (results is not none and results.shape[0] > 0 and 'naissance' in row) else '' }}";
            </script>
            <script src="{{ url_for('static', filename='js/client_file.js') }}"></script>

</body>

</html>