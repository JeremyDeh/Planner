<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <title>Formulaire de Contrat Interface</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    </head>
    <body>
        <style>
            body {
                margin: 0;
                font-family: 'Segoe UI', Arial, sans-serif;
                background: #f7f7fa;
            }
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 200px;
                height: 100vh;
                background: linear-gradient(180deg, #4F8CFF 0%, #232946 100%);
                display: flex;
                flex-direction: column;
                align-items: stretch;
                padding-top: 40px;
                box-shadow: 2px 0 16px rgba(35,41,70,0.10);
                border-radius: 0 24px 24px 0;
                z-index: 100;
            }
            .menu-btn {
                background: rgba(255,255,255,0.08);
                color: #fff;
                border: none;
                padding: 16px 0;
                margin: 0 18px 16px 18px;
                border-radius: 10px;
                font-size: 1.08em;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.2s;
                box-shadow: 0 2px 8px rgba(35,41,70,0.04);
                letter-spacing: 1px;
            }
            .menu-btn:hover, .menu-btn.active {
                background: #fff;
                color: #232946;
                box-shadow: 0 4px 16px rgba(35,41,70,0.12);
                transform: scale(1.04);
            }
            .central-panel {
                margin-left: 220px;
                padding: 40px 40px 40px 40px;
                min-height: 100vh;
                background: #f7f7fa;
            }
        </style>
        <div class="sidebar">
            <button onclick="window.location.href='{{ url_for('main.journee') }}'" class="menu-btn{% if request.path == url_for('main.journee') %} active{% endif %}">Page principale</button>
            <button onclick="window.location.href='{{ url_for('main.client_file') }}'" class="menu-btn{% if request.path == url_for('main.client_file') %} active{% endif %}">Fiche r√©sident</button>
            <button onclick="window.location.href='{{ url_for('main.form') }}'" class="menu-btn{% if request.path == url_for('main.form') or request.path == '/' %} active{% endif %}">Prise de rendez-vous</button>
            <button onclick="window.location.href='{{ url_for('main.emploi_collectif') }}'" class="menu-btn{% if request.path == url_for('main.emploi_collectif') %} active{% endif %}">Emploi du temps collectif</button>
            <button onclick="window.location.href='{{ url_for('main.admin') }}'" class="menu-btn{% if request.path == url_for('main.admin') %} active{% endif %}">Adminstration</button>
        </div>
        <div class="central-panel" style="padding-top:100px;">
        <div style="width:calc(100vw - 200px); margin-left:0; margin-top:0; margin-bottom:32px; height:80px; background:linear-gradient(90deg, #4F8CFF 0%, #232946 100%); box-shadow:0 4px 24px rgba(35,41,70,0.10); border-radius:0 0 32px 32px; display:flex; align-items:center; padding-left:48px; position:fixed; top:0; left:220px; z-index:101;">
            <img src="https://img.icons8.com/ios-filled/50/ffffff/calendar--v2.png" alt="Logo" style="height:48px; width:48px; margin-right:24px; filter:drop-shadow(0 2px 8px #23294655);">
            <span style="font-size:2.2em; font-weight:700; color:#fff; letter-spacing:2px; text-shadow:0 2px 8px #23294655;">Formulaire de rendez-vous</span>
        </div>

        <form id="monForm" method="post" onsubmit="return validerFormulaire();">

            <label><input type="checkbox" name="fichierCSV" id="fichierCSV" onchange="toggleCSVFields()"> R√©currence </label>

            <div id="schemaField">
                <label>Type de r√©currence :
                    <select name="recurrence" required>
                        <option value="jour">Tout les jours</option>
                        <option value="semaine">Toutes les semaines</option>
                        <option value="mois">Tout les mois</option>

                    </select>
                </label>
            </div>
            
            
            <label>Date :
                <input type="date" name="date_prestation" style="width: 220px;" required title="Choisissez la date de la prestation">
            </label>

            <div id="dateFinField" style="display:none;">
                <label>Date de fin :
                    <input type="date" name="date_fin" style="width: 220px;" title="Choisissez la date de fin">
                </label>
            </div>
            </label>

            <label>Heure du rendez-vous :
                <input type="time" name="heure_prestation" style="width: 150px;"  title="S√©lectionnez l'heure et les minutes de la prestation">
            </label>

            <label>Dur√©e du rendez-vous :
                <input type="time" name="duree_prestation" style="width: 150px;" required title="S√©lectionnez l'heure et les minutes de la prestation">
            </label>
            
            <label>Nom du r√©sident :</label>
            <div style="position:relative;">
            <!-- Champ texte affich√© √† l'utilisateur -->
            <input type="text" name="nomPatient_affichage" id="nomPatientInput" 
                autocomplete="off" placeholder="Commencez √† taper..." required 
                onfocus="showPatientList()" oninput="filterPatientList()">

            <!-- Champ cach√© pour envoyer la PK au backend -->
            <input type="hidden" name="nomPatient" id="nomPatientHidden">

            <div id="patientList" style="display:none; position:absolute; left:0; right:0; 
                                        background:#fff; border:1px solid #ccc; 
                                        max-height:200px; overflow-y:auto; z-index:10;">
                {% for nom in residents %}
                    <div class="patient-item" 
                        data-pk="{{ pks[loop.index0] }}" 
                        style="padding:8px; cursor:pointer;" 
                        onclick="selectPatient(this)">
                        {{ nom }}
                    </div>
                {% endfor %}
            </div>
        </div>


            <div style="display: flex; gap: 32px; align-items: flex-start; margin-bottom: 12px;">
                <div style="flex:1; min-width:220px;">
                    <label>Type de rendez-vous :</label>
                    <div style="position:relative;">
                        <input type="text" name="nomMedecin" id="nomMedecinInput" autocomplete="off" placeholder="Commencez √† taper..." required onfocus="showMedecinList()" oninput="filterMedecinList()">
                        <div id="medecinList" style="display:none; position:absolute; left:0; right:0; background:#fff; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:10;">
                            {% for nom in medecins %}
                                <div class="medecin-item" onclick="selectMedecin('{{ nom }}')" style="padding:8px; cursor:pointer;">{{ nom }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div style="flex:1; min-width:220px;">
                    <label>Nom du m√©decin (optionnel) :</label>
                    <input type="text" name="identiteMedecin" >
                </div>
            </div>
            <label>Lieu :
                <input type="text" name="lieu" style="width: 100%;">
            </label>
            


            <label>Type de transport :
                <select name="transport" required>
                    <option value="" disabled selected hidden>-- S√©lectionnez un type de transport --</option>
                    <option value="vsl">VSL</option>
                    <option value="ambulance">Ambulance</option>
                    <option value="famille">Famille</option>
                    <option value="---">Absence de transport</option>
                </select>
            </label>

            <label>Visibilit√© dans le planning :</label>
            <div style="position:relative;">
                <input type="text" name="nomService" id="nomServiceInput" autocomplete="off" placeholder="Commencez √† taper..." required onfocus="showServiceList()" oninput="filterServiceList()">
                <div id="serviceList" style="display:none; position:absolute; left:0; right:0; background:#fff; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:10;">
                    {% for nom in service %}
                        <div class="service-item" onclick="selectService('{{ nom }}')" style="padding:8px; cursor:pointer;">{{ nom }}</div>
                    {% endfor %}
                </div>
            </div>
            <script>
                function showPatientList() {
                    document.getElementById('patientList').style.display = 'block';
                }

                function hidePatientList() {
                    setTimeout(function() {
                        document.getElementById('patientList').style.display = 'none';
                    }, 200);
                }

                function selectPatient(element) {
                    // Nom affich√© dans le champ texte
                    document.getElementById('nomPatientInput').value = element.textContent.trim();

                    // PK envoy√©e dans le champ hidden
                    document.getElementById('nomPatientHidden').value = element.getAttribute('data-pk');

                    hidePatientList();
                }

                function filterPatientList() {
                    var input = document.getElementById('nomPatientInput').value.toLowerCase();
                    var items = document.querySelectorAll('#patientList .patient-item');
                    items.forEach(function(item) {
                        if (item.textContent.toLowerCase().includes(input)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                }

                document.getElementById('nomPatientInput').addEventListener('blur', hidePatientList);

                function showMedecinList() {
                    document.getElementById('medecinList').style.display = 'block';
                }
                function hideMedecinList() {
                    setTimeout(function() {
                        document.getElementById('medecinList').style.display = 'none';
                    }, 200);
                }
                function selectMedecin(nom) {
                    document.getElementById('nomMedecinInput').value = nom;
                    hideMedecinList();
                }
                function filterMedecinList() {
                    var input = document.getElementById('nomMedecinInput').value.toLowerCase();
                    var items = document.querySelectorAll('#medecinList .medecin-item');
                    items.forEach(function(item) {
                        if (item.textContent.toLowerCase().includes(input)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                }
                document.getElementById('nomMedecinInput').addEventListener('blur', hideMedecinList);
                
                function showServiceList() {
                    document.getElementById('serviceList').style.display = 'block';
                }
                function hideServiceList() {
                    setTimeout(function() {
                        document.getElementById('serviceList').style.display = 'none';
                    }, 200);
                }
                function selectService(nom) {
                    document.getElementById('nomServiceInput').value = nom;
                    hideServiceList();
                }
                function filterServiceList() {
                    var input = document.getElementById('nomServiceInput').value.toLowerCase();
                    var items = document.querySelectorAll('#serviceList .service-item');
                    items.forEach(function(item) {
                        if (item.textContent.toLowerCase().includes(input)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                }
                document.getElementById('nomServiceInput').addEventListener('blur', hideServiceList);
            </script>
            <label>Commentaire :
                <input type="text" name="commentaire" style="width: 100%;">
            </label>

            <div id="dependsContainer" style="display: none;">
                <h3>D√©pendances</h3>
                <div id="dependsFields"></div>
                <button type="button" onclick="ajouterDependance()" class="add-btn">+ Ajouter une d√©pendance</button>
            </div>

            <div id="csvFields">
                
            </div>

            <h3>Rappels</h3>
            <div id="colonnesContainer"></div>

            <div style="margin-top: 10px;">
                <button type="button" onclick="ajouterColonne()" class="add-btn">+ Ajouter une colonne</button>
            </div>

            <div id="errorMsg" style="color: red; font-weight: bold; display: none; margin-bottom: 10px;"></div>
            <input type="submit" value="Valider"> 

            <div id="popupConfirmation" class="popup noselect" style="display: none;", onclick="resetForm()">
                <div class="popup-content">
                    <h2>‚úÖ Rendez-vous enregistr√© avec succ√®s</h2>
                    <button type="button" onclick="resetForm()" class="btn-nouveau">+ Nouveau rendez-vous</button>
                </div>
            </div>

        </form>
        </div>

        <script>
            let colonneData = [{ name: '', unit: 'Jour', nombre: '', pk: '' }];

            function toggleCSVFields() {
                const isChecked = document.getElementById('fichierCSV').checked;
                document.getElementById('csvFields').style.display = isChecked ? 'block' : 'none';
                document.querySelectorAll('#csvFields input').forEach(input => {
                    input.required = isChecked;
                });

                // Masquer le champ "schema" si fichierCSV est coch√©
                document.getElementById('schemaField').style.display = isChecked ? 'block' : 'none';
                document.getElementById('dateFinField').style.display = isChecked ? 'block' : 'none';
            }

            window.onload = function () {
                toggleCSVFields();
                renderColonnes();
            };

            function ajouterColonne() {
            // Sauvegarder les champs actuels du DOM
            const fields = document.querySelectorAll('#colonnesContainer fieldset');
            colonneData = Array.from(fields).map((fieldset) => {
                return {
                    name: fieldset.querySelector('[name$="_name"]')?.value || '',
                    unit: fieldset.querySelector('[name$="_unit"]')?.value || '',
                    nombre: fieldset.querySelector('[name$="_nombre"]')?.value || '',
                    pk: fieldset.querySelector('[name$="_pk"]')?.checked ? 'Y' : ''
                };
            });

            // Ajouter une nouvelle colonne vide bien form√©e
            colonneData.push({
                name: '',
                unit: '',
                nombre: '',
                pk: ''
            });

            renderColonnes();
        }


            function supprimerColonne(index) {
            console.log("Suppression de la colonne index :", index); // üëà ligne ajout√©e

            const fields = document.querySelectorAll('#colonnesContainer fieldset');
            colonneData = Array.from(fields).map((fieldset) => {
                return {
                    name: fieldset.querySelector('[name$="_name"]')?.value || '',
                    unit: fieldset.querySelector('[name$="_unit"]')?.value || '',
                    nombre: fieldset.querySelector('[name$="_nombre"]')?.value || '',
                    pk: fieldset.querySelector('[name$="_pk"]')?.checked ? 'Y' : ''
                };
            });

            colonneData.splice(index, 1);
            renderColonnes();
        }

        function renderColonnes() {
            const container = document.getElementById('colonnesContainer');

            // Sauvegarde de l‚Äô√©l√©ment actif (input) et position du curseur
            const activeElement = document.activeElement;
            const selectionStart = activeElement?.selectionStart;
            const selectionEnd = activeElement?.selectionEnd;
            const activeName = activeElement?.name;

            // Nettoyage du container
            container.innerHTML = '';


            colonneData.forEach((col, index) => {
                const fieldset = document.createElement('fieldset');

                fieldset.innerHTML = `
                    <legend>Rappel ${index + 1}</legend>

                    <div class="reorder-buttons">
                        <button type="button" onclick="moveUp(${index})" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                        <button type="button" onclick="moveDown(${index})" ${index === colonneData.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
                    </div>

                    <div class="ligne-champs">
                        <label class="col-nom">Raison :
                            <input type="text" name="col${index + 1}_name" value="${col.name}">
                        </label>
                        <label class="col-unit">Unit√© :
                            <select name="col${index + 1}_unit">
                                <option value="jour" ${col.unit === "Jours" ? "selected" : ""}>Jours</option>
                                <option value="semaine" ${col.unit === "Semaines" ? "selected" : ""}>Semaines</option>
                                <option value="mois" ${col.unit === "Mois" ? "selected" : ""}>Mois</option>
                            </select>
                        </label>
                        <label class="col-nombre">Nombre :
                            <input type="text" name="col${index + 1}_nombre" value="${col.nombre}">
                        </label>
                    </div>

                    <label>
                        <input type="checkbox" name="col${index + 1}_pk" value="Y" ${col.pk === 'Y' ? 'checked' : ''}> Obligatoire
                    </label>

                    <div class="delete-btn-container">
                        <button type="button" onclick="supprimerColonne(${index})" class="delete-btn">Supprimer</button>
                    </div>
                `;

                container.appendChild(fieldset);

                // Gestion dynamique du champ "Nom"
                const inputNom = fieldset.querySelector(`[name="col${index + 1}_name"]`);
                inputNom.addEventListener('input', () => {
                    const value = inputNom.value;
                    colonneData[index].name = value;

                    const isLast = index === colonneData.length - 1;
                    const isEmpty = value.trim() === '';

                    if (isLast && !isEmpty) {
                        colonneData.push({ name: '', unit: 'VARCHAR', nombre: '', pk: '' });
                        renderColonnes();
                    } else if (!isLast && isEmpty && isColonneEmpty(index)) {
                        colonneData.splice(index, 1);
                        renderColonnes();
                    }
                });
            });

            // üîô Restaurer le focus si l‚Äô√©l√©ment est toujours pr√©sent
            if (activeName) {
                const restoredInput = document.querySelector(`[name="${activeName}"]`);
                if (restoredInput) {
                    restoredInput.focus();
                    if (selectionStart !== null && selectionEnd !== null) {
                        restoredInput.setSelectionRange(selectionStart, selectionEnd);
                    }
                }
            }
        }



        function isColonneEmpty(index) {
            const fieldset = document.querySelectorAll('#colonnesContainer fieldset')[index];
            if (!fieldset) return false;

            const name = fieldset.querySelector(`[name="col${index + 1}_name"]`)?.value.trim();
            const unit = fieldset.querySelector(`[name="col${index + 1}_unit"]`)?.value.trim();
            const nombre = fieldset.querySelector(`[name="col${index + 1}_nombre"]`)?.value.trim();
            const pk = fieldset.querySelector(`[name="col${index + 1}_pk"]`)?.checked;

            return name === '' && unit === 'VARCHAR' && nombre === '' && !pk;
        }




        function validerFormulaire() {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.style.display = 'none';

            // üîÑ Mise √† jour de colonneData √† partir du DOM
            const fields = document.querySelectorAll('#colonnesContainer fieldset');
            colonneData = Array.from(fields).map((fieldset, i) => {
                return {
                    name: fieldset.querySelector(`[name="col${i + 1}_name"]`)?.value || '',
                    unit: fieldset.querySelector(`[name="col${i + 1}_unit"]`)?.value || '',
                    nombre: fieldset.querySelector(`[name="col${i + 1}_nombre"]`)?.value || '',
                    pk: fieldset.querySelector(`[name="col${i + 1}_pk"]`)?.checked ? 'Y' : ''
                };
            });

            if (colonneData.length === 0) {
                errorMsg.innerText = "Veuillez ajouter au moins une colonne.";
                errorMsg.style.display = 'block';
                return false;
            }

            const fieldsets = document.querySelectorAll('#colonnesContainer fieldset');
            for (let i = 0; i < fieldsets.length; i++) {
                const fs = fieldsets[i];
                const name = fs.querySelector(`[name^="col${i + 1}_name"]`)?.value.trim();

                if (name) {
                    const unit = fs.querySelector(`[name^="col${i + 1}_unit"]`)?.value.trim();
                    if (!unit) {
                        errorMsg.innerText = "Le type est obligatoire pour chaque colonne ayant un nom.";
                        errorMsg.style.display = 'block';
                        return false;
                    }
                }
            }

           

            return true;
        }


        let dependances = [];

        function toggleCSVFields() {
            const isChecked = document.getElementById('fichierCSV').checked;

            document.getElementById('csvFields').style.display = isChecked ? 'block' : 'none';
            document.querySelectorAll('#csvFields input').forEach(input => {
                input.required = isChecked;
            });

            document.getElementById('schemaField').style.display = isChecked ? 'block' : 'none';
            document.getElementById('dateFinField').style.display = isChecked ? 'block' : 'none';

            // Affiche depends_on uniquement si ce n'est PAS un fichier CSV
            document.getElementById('dependsContainer').style.display = isChecked ? 'none' : 'block';
        }

        function ajouterDependance() {
            dependances = Array.from(document.querySelectorAll('input[name="depends_on"]')).map(input => input.value);
            dependances.push('');
            renderDependances();
        }


        function supprimerDependance(index) {
            // Sauvegarder l'√©tat actuel
            dependances = Array.from(document.querySelectorAll('input[name="depends_on"]')).map(input => input.value);

            // Supprimer l'√©l√©ment √† l'index donn√©
            dependances.splice(index, 1);

            // Re-render avec le tableau mis √† jour
            renderDependances();
        }


        function renderDependances() {
            const container = document.getElementById('dependsFields');
            container.innerHTML = '';

            dependances.forEach((val, index) => {
                const div = document.createElement('div');
                div.className = "dependance-row";
                div.innerHTML = `
                    <span class="dependance-label">Truc d√©pendant ${index + 1} :</span>
                    <input type="text" name="depends_on" value="${val}" required>
                    <button type="button" onclick="supprimerDependance(${index})" class="delete-btn">Supprimer</button>
                `;
                container.appendChild(div);
            });
        }


        document.querySelector("form").addEventListener("submit", async function(e) {
            e.preventDefault();

            if (!validerFormulaire()) return;

            // Print all form fields
            const formData = new FormData(this);
            const entries = Array.from(formData.entries());
            console.log('Formulaire soumis:');
            entries.forEach(([key, value]) => {
                console.log(key + ':', value);
            });

            const response = await fetch("/", {
                method: "POST",
                body: formData
            });

            if (response.ok) {
                document.getElementById("popupConfirmation").style.display = "flex";
            } else {
                alert("Erreur lors de la g√©n√©ration du fichier.");
            }
        });

        function resetForm() {
            console.log("LA");
            document.getElementById("popupConfirmation").style.display = "none";
            console.log("ICI");
            colonneData = [{ name: '', unit: 'VARCHAR', nombre: '', pk: '' }];
            renderColonnes();
            toggleCSVFields();
            console.log("resetForm called");
            scrollToTop(1000);
            setTimeout(() => {
            location.reload(true)
            }, 800);
        }
        
        function scrollToTop(duration) {
        const start = window.pageYOffset;
        const startTime = performance.now();

        function scroll() {
            const now = performance.now();
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / duration, 1); // de 0 √† 1

            // Ease out cubic pour un effet smooth
            const ease = 1 - Math.pow(1 - progress, 3);

            window.scrollTo(0, start * (1 - ease));

            if (progress < 1) {
            requestAnimationFrame(scroll);
            }
        }

        requestAnimationFrame(scroll);
        }

// Usage : remonter sur 3 secondes (3000 ms)
scrollToTop(3000);

        function moveUp(index) {
            if (index > 0) {
                [colonneData[index], colonneData[index - 1]] = [colonneData[index - 1], colonneData[index]];
                renderColonnes();
            }
        }

        function moveDown(index) {
            if (index < colonneData.length - 1) {
                [colonneData[index], colonneData[index + 1]] = [colonneData[index + 1], colonneData[index]];
                renderColonnes();
            }
        }

        function showPopup() {
  const popup = document.getElementById("popupConfirmation");
  popup.style.display = "block";

  // Attendre que le DOM soit pr√™t et ajouter un listener global
  setTimeout(() => {
    document.addEventListener("click", handleOutsideClick);
  }, 0);
}

function handleOutsideClick() {
  resetForm(); // Ce que tu veux faire au clic hors popup
  document.removeEventListener("click", handleOutsideClick);
}
        </script>
    </body>
</html>
